<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Back to Marshal'ed Cookie-Serialization | Devnull</title>
  
  <meta name="author" content="Carsten Zimmermann" />
  
  
  <link rel="author" href="https://plus.google.com/u/0/101728608052847168461" />
  

  <meta property="og:site_name" content="Devnull – The blog of the ABSOLVENTA Dev Team" />
  <meta property="og:title" content="Back to Marshal'ed Cookie-Serialization" />
  <meta property="og:url" content="http://devnull.absolventa.de/2014/08/30/migrating-back-to-marshal-ed-cookie-serialization-in-rails-4-1/" />

  
  <meta property="og:image" content="http://devnull.absolventa.de/images/og-absolventacat.png" />
  

  <meta lang="en" name="keywords" xml:lang="en" content="ruby, rails, upgrade, rollback, session, marshal, json" />
  
  <meta lang="en" name="description" xml:lang="en" content="Upgrading to Rails v4.1, it felt like a good idea to switch to the new default serialization format: JSON. Except, later it didn't. Rails offers a migration path from Marshal to JSON, but not vice versa. This article offers a (somewhat hacky) solution to rollback from JSON to Marshal." />
  <meta property="og:description" content="Upgrading to Rails v4.1, it felt like a good idea to switch to the new default serialization format: JSON. Except, later it didn't. Rails offers a migration path from Marshal to JSON, but not vice versa. This article offers a (somewhat hacky) solution to rollback from JSON to Marshal." />
  
  <link rel="canonical" href="http://devnull.absolventa.de/2014/08/30/migrating-back-to-marshal-ed-cookie-serialization-in-rails-4-1/" />

  <!-- <link href="//fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css"> -->
  <!-- <link href='http://fonts.googleapis.com/css?family=Gudea' rel='stylesheet' type='text/css'> -->
  <link href='http://fonts.googleapis.com/css?family=Rosario' rel='stylesheet' type='text/css'>
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternate" type="application/rss+xml" title="Devnull" href="http://devnull.absolventa.de/feed.xml" />

  <link rel="stylesheet" href="/assets/css/all.css">
<!--[if IE 7]>
  <link rel="stylesheet" href="/assets/css/font-awesome-ie7.min.css">
<![endif]-->
</head>
<body>
  <div class="container">
    <div class="four columns sidebar">
      <nav>
  <a href="/">
    <img src="/images/absolventa_logo_large.png" id="logo" alt="Blog logo"/>
  </a>
  <h1><a href="/">Devnull</a></h1>
  <hr/>
    <p>The Blog of the <a href="https://www.absolventa.de/">ABSOLVENTA</a> Dev Team.</p>
  <hr/>
  <div>
    <div>
      <ul>
        <li><a href="/about">About ABSOLVENTA</a></li>
      </ul>
    </div>
    <div id="social">
      Follow us:
<div id="stalker">
  
  <a title="Absolventa on Github" href="http://github.com/Absolventa">
    <i class="icon-github-sign"></i>
  </a>
  

  

  
  <a title="ABSOLVENTA on Twitter" href="http://twitter.com/ABSOLVENTA">
    <i class="icon-twitter-sign"></i>
  </a>
  

  <a title="RSS feed" id="rss" href="/feed.xml">
    <i class="icon-rss-sign"></i>
  </a>
</div>

    </div>
  </div>
</nav>

    </div>

    <div class="eleven columns content">
      <h1 class="title">Back to Marshal'ed Cookie-Serialization</h1>

<p class="meta">
  Posted on August 30, 2014 by Carsten Zimmermann
  <ul class="tags">
  
    <li><a href='/tag/ruby'>ruby</a></li>
  
    <li><a href='/tag/rails'>rails</a></li>
  
    <li><a href='/tag/upgrade'>upgrade</a></li>
  
    <li><a href='/tag/rollback'>rollback</a></li>
  
    <li><a href='/tag/session'>session</a></li>
  
    <li><a href='/tag/marshal'>marshal</a></li>
  
    <li><a href='/tag/json'>json</a></li>
  
</ul>
<div style="clear:both"></div>

</p>

<div id="post">
  <p>Upgrading to Rails v4.1, it felt like a good idea to switch to the new default
serialization format: JSON. Upgrading from the Marshal’ed serialization to JSON
was as simple as setting Rails’ cookies serializer to <code>:hybrid</code>. Easy enough and
»better go with the new Rails default«, I thought.</p>

<p>We were warned about the implications.
<a href="http://edgeguides.rubyonrails.org/upgrading_ruby_on_rails.html#upgrading-from-rails-4-0-to-rails-4-1">The Rails Upgrade Guide</a>
states:</p>

<blockquote>
  <p>When using the :json or :hybrid serializer, you should beware that not all Ruby
objects can be serialized as JSON. For example, Date and Time objects will be
serialized as strings, and Hashes will have their keys stringified.</p>
</blockquote>

<p>Only we had to realize the hard way that an external library was dumping high
level objects into the (cookie-based) session that couldn’t easily and
transparently deserialized again.</p>

<p>Unfortunately, there is no real rollback option: Setting the serializer back to
<code>:marshal</code> will get you parser errors, when <code>Marshal.load</code> is fed with JSON
data.</p>

<p>Since our application started generating JSON-serialized session data after our
change was rolled out, I came up with the following »rolling rollback« strategy:</p>

<div class="highlight"><pre><code class="ruby"><span class="c1"># app/controllers/application_controller.rb</span>

<span class="n">rescue_from</span> <span class="s1">&#39;TypeError&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">starts_with?</span> <span class="s1">&#39;incompatible marshal file format&#39;</span>
    <span class="n">store</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">new</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="o">::</span><span class="no">Session</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
    <span class="n">reset_session</span>
  <span class="k">else</span>
    <span class="k">raise</span> <span class="n">e</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>A simple <code>reset_session</code> won’t do as that already tries to access the (invalid)
session object. The rescue hook will regenerate a new Marshal-serialized session
for all those who have already received JSON data, but will of course terminate
their existing sessions (login data, shopping cart … you name it).</p>


</div>


  <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'absolventa-devnull'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



<div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
    <li>
      <span>06 Aug 2014 &raquo;</span> <a href="/2014/08/06/ruby-on-waves/">Ruby on Waves: Πάντα ῥεῖ</a>
    </li>
    
    <li>
      <span>22 May 2014 &raquo;</span> <a href="/2014/05/22/mass-truncate-your-rails-test-log-files/">Bulk-Truncate Your Rails Apps' test.logs</a>
    </li>
    
    <li>
      <span>04 Apr 2014 &raquo;</span> <a href="/2014/04/04/vim-berlin-usergroup-absolventa/">Vim Berlin Usergroup @ ABSOLVENTA</a>
    </li>
    
  </ul>
</div>

    
      <div class="footer">
        <div class="disclaimer">
  

  <p>
    © ABSOLVENTA, 2013-2014 &mdash; built with Jekyll using Lagom theme
  </p>
</div>

      </div>
    </div>
  </div>


<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
   var t   = document.createElement('script');
   t.type  = 'text/javascript';
   t.async = true;
   t.id    = 'gauges-tracker';
   t.setAttribute('data-site-id', '52567bcc613f5d6ad7000042');
   t.src = '//secure.gaug.es/track.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(t, s);
   })();
</script>



</body>
</html>
