<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Devnull - Aggregate And Conquer</title>
  <meta name="author" content="ABSOLVENTA" />
  <meta name="description" content="The blog of the ABSOLVENTA Dev Team" />
  <link rel="canonical" href="http://devnull.absolventa.de/2013/11/11/aggregate-and-conquer/" />

  <!-- <link href="//fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css"> -->
  <!-- <link href='http://fonts.googleapis.com/css?family=Gudea' rel='stylesheet' type='text/css'> -->
  <link href='http://fonts.googleapis.com/css?family=Rosario' rel='stylesheet' type='text/css'>
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternate" type="application/rss+xml" title="Devnull" href="http://devnull.absolventa.de/feed.xml" />

  <link rel="stylesheet" href="/assets/css/all.css">
<!--[if IE 7]>
  <link rel="stylesheet" href="/assets/css/font-awesome-ie7.min.css">
<![endif]-->
</head>
<body>
  <div class="container">
    <div class="four columns sidebar">
      <nav>
  <a href="/">
    <img src="/images/absolventa_logo_large.png" id="logo" alt="Blog logo"/>
  </a>
  <h1><a href="/">Devnull</a></h1>
  <hr/>
  <ul>
    <p>The Blog of the <a href="https://www.absolventa.de/">ABSOLVENTA</a> Dev Team.</p>
  <hr/>
  <div>
    <div id="social">
      Follow us:
<div id="stalker">
  
  <a title="Absolventa on Github" href="http://github.com/Absolventa">
    <i class="icon-github-sign"></i>
  </a>
  

  

  
  <a title="ABSOLVENTA on Twitter" href="http://twitter.com/ABSOLVENTA">
    <i class="icon-twitter-sign"></i>
  </a>
  

  <a title="RSS feed" id="rss" href="/feed.xml">
    <i class="icon-rss-sign"></i>
  </a>
</div>

    </div>
  </div>
  </ul>
</nav>

    </div>

    <div class="eleven columns content">
      <h1 class="title">Aggregate And Conquer</h1>

<p class="meta">
  Posted on November 11, 2013 by Robin Neumann
  <ul class="tags">
  
    <li><a href='/tag/activerecord'>activerecord</a></li>
  
    <li><a href='/tag/postgresql'>postgresql</a></li>
  
    <li><a href='/tag/rails'>rails</a></li>
  
    <li><a href='/tag/statistics'>statistics</a></li>
  
</ul>
<div style="clear:both"></div>

</p>

<div id="post">
  
<p>Collecting stats is awesome. Analytical brains love being fed with stats. So let’s fire these tiny queries at our database asking for favourite customer choices of recent years and – meanwhile – grab a coffee … or write a book or a whole new app until your answer is served.</p>

<p>Persisting events over years is no problem for modern database systems in general, but accessing them later could be. Of course, you can come over it anytime by pimping up your server or database setup. But often it’s not the best solution to scale a mid-size app artificially this way only because you want to save historical data.</p>

<p>In our case, we’re deeply interested in pageview statistics related to templates for model instances of a Rails app. For that use case we created a custom Rails Engine (»Kanyotoku«) that provides this service for some of our bigger apps.</p>

<p>And of course, when developing our tool, I directly ran into the problems as described above. To come over this, I was inspired by a <a href='http://www.railstips.org/blog/archives/2011/06/28/counters-everywhere/' target='_blank'>blog post</a> by John Nunemaker, one of the creators of Gaug.es, a really awesome pageview tracking service. Even though most of his thoughts concern schemaless data, it was easy to adopt and modify these principles for a PostgreSQL system.</p>

<h3 id="be_writeheavy_but_readlazy">Be write-heavy, but read-lazy</h3>

<p>One of his ideas was choosing appropriate resolutions, i.e. time frame resolutions for your data. Let’s translate this principle as follows: Do we need to know how many pageviews occurred in the last ten minutes exactly? Is this really relevant?</p>

<p>For our situation it was much more interesting to know the count of pageviews per month or maybe per day. It is also interesting for us to count it per year or for 3 months, but any smaller timeframe is nigh irrelevant for all our purposes.</p>

<p>For that reason, we introduced daily and monthly reports that are saved and/or updated each time a pageview record is created. Of course this means we’re much more write-heavy than before.</p>
<script src='https://gist.github.com/7409048.js?file=pageviews.rb'><![CDATA[ ]]></script>
<p>On each page visit, a pageview gets saved and written to the database and in addtion to that a daily report is created or updated if it exists for that day. A monthly report is handled the same way.</p>

<p>All reports save the pageviews count of the related time frame as an integer column which is simply incremented if desired. As a result, we have done some pre-processing for data analysis in the backend - we have aggregated tables that fit perfectly to our range needs. In out backoffice data aggregation context, we can simply sum these integer values. If you’re interested in the pageviews of the last 5 years, you can collect your data like</p>
<script src='https://gist.github.com/7409097.js?file=elephant.rb'><![CDATA[ ]]></script>
<p>Assumimg our elephant receives around 10,000 pageviews per year, it is great that we don’t have to load 50,000 pageview records. Summing up integer values of less than 5 * 12 = 60 reports should be an easy excercise for our database.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In out situation, being a little more write heavy has no measurable negative impact on request times in our frontend context, but it highly improves out backoffice data aggregation performance – q.e.d!</p>

</div>

<div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
    <li>
      <span>28 Oct 2013 &raquo;</span> <a href="/2013/10/28/watching-a-certificate-revocation-list-using-event-girl/">Watching A Certificate Revocation List Using Event Girl</a>
    </li>
    
    <li>
      <span>10 Oct 2013 &raquo;</span> <a href="/2013/10/10/rate-limiting-with-activerecord-base-find_each-in-edge-rails/">Rate Limiting Work On ActiveRecord::Base With .find_each In Edge Rails</a>
    </li>
    
  </ul>
</div>

    
      <div class="footer">
        <div class="disclaimer">
  

  <p>
    © ABSOLVENTA, 2013 &mdash; built with Jekyll using Lagom theme
  </p>
</div>

      </div>
    </div>
  </div>


<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
   var t   = document.createElement('script');
   t.type  = 'text/javascript';
   t.async = true;
   t.id    = 'gauges-tracker';
   t.setAttribute('data-site-id', '52567bcc613f5d6ad7000042');
   t.src = '//secure.gaug.es/track.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(t, s);
   })();
</script>



</body>
</html>
