<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rate Limiting Work On ActiveRecord::Base With .find_each In Edge Rails | Devnull</title>
  <meta name="author" content="ABSOLVENTA" />
  <meta lang="en" name="keywords" xml:lang="en" content="ruby, enumerator, activerecord, enumerable, edgerails" />
  
  <link rel="canonical" href="http://devnull.absolventa.de/2013/10/10/rate-limiting-with-activerecord-base-find_each-in-edge-rails/" />

  <!-- <link href="//fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css"> -->
  <!-- <link href='http://fonts.googleapis.com/css?family=Gudea' rel='stylesheet' type='text/css'> -->
  <link href='http://fonts.googleapis.com/css?family=Rosario' rel='stylesheet' type='text/css'>
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternate" type="application/rss+xml" title="Devnull" href="http://devnull.absolventa.de/feed.xml" />

  <link rel="stylesheet" href="/assets/css/all.css">
<!--[if IE 7]>
  <link rel="stylesheet" href="/assets/css/font-awesome-ie7.min.css">
<![endif]-->
</head>
<body>
  <div class="container">
    <div class="four columns sidebar">
      <nav>
  <a href="/">
    <img src="/images/absolventa_logo_large.png" id="logo" alt="Blog logo"/>
  </a>
  <h1><a href="/">Devnull</a></h1>
  <hr/>
    <p>The Blog of the <a href="https://www.absolventa.de/">ABSOLVENTA</a> Dev Team.</p>
  <hr/>
  <div>
    <div>
      <ul>
        <li><a href="/about">About ABSOLVENTA</a></li>
      </ul>
    </div>
    <div id="social">
      Follow us:
<div id="stalker">
  
  <a title="Absolventa on Github" href="http://github.com/Absolventa">
    <i class="icon-github-sign"></i>
  </a>
  

  

  
  <a title="ABSOLVENTA on Twitter" href="http://twitter.com/ABSOLVENTA">
    <i class="icon-twitter-sign"></i>
  </a>
  

  <a title="RSS feed" id="rss" href="/feed.xml">
    <i class="icon-rss-sign"></i>
  </a>
</div>

    </div>
  </div>
</nav>

    </div>

    <div class="eleven columns content">
      <h1 class="title">Rate Limiting Work On ActiveRecord::Base With .find_each In Edge Rails</h1>

<p class="meta">
  Posted on October 10, 2013 by Carsten Zimmermann
  <ul class="tags">
  
    <li><a href='/tag/ruby'>ruby</a></li>
  
    <li><a href='/tag/enumerator'>enumerator</a></li>
  
    <li><a href='/tag/activerecord'>activerecord</a></li>
  
    <li><a href='/tag/enumerable'>enumerable</a></li>
  
    <li><a href='/tag/edgerails'>edgerails</a></li>
  
</ul>
<div style="clear:both"></div>

</p>

<div id="post">
  
<p>I was working with several maintenance tasks that query external webservices for a collection of ActiveRecord objects. In order to avoid hitting the webservices’ rate limit, we pause every other iteration for a fraction of a second before we continue.</p>

<p>The code looks something like this:</p>
<script src='https://gist.github.com/6920157.js?file=old_code.rb'><![CDATA[ ]]></script>
<p>I didn’t like that the information of our rate limit guard clauses was so scattered: there were bits before the block and others in the block. I had the urge to refactor it into a more concise form using a Ruby block itself.</p>

<p>My idea was to create a method that takes the rate limit, the sleep time and an enumeration and then yield the elements of the enum to a block.</p>

<p>I wrapped that method into a module and out came this:</p>
<script src='https://gist.github.com/6920157.js?file=rate_limiter.rb'><![CDATA[ ]]></script>
<p>This is how the specs look like:</p>
<script src='https://gist.github.com/6920157.js?file=rate_limiter_spec.rb'><![CDATA[ ]]></script>
<p>Unfortunately and unlike other enumerable methods, the batch finder <code>ActiveRecord::Base.find_each</code> does not return an Enumerator when called without a block. Not in Rails 3.2 and not in Rails 4.0.</p>

<p>Luckily, it has been solved in Edge Rails (see <a href="https://github.com/rails/rails/commit/840c552047a660d0a66883fb9c0cb144d5e728fb">840c552</a>) and I quickly created a Rails 4.1.0.beta app to go for the following code:</p>
<script src='https://gist.github.com/6920157.js?file=external_service.rb'><![CDATA[ ]]></script>
<p><code>ActiveRecord::Base.find_each</code> now returns a proper <code>Enumerator</code> that can be passed into the rate limiter. If you want to learn more about Enumerators in Ruby (or if you’d like to refresh your memory), I can recommend this excellent <a href="http://devblog.avdi.org/2013/09/10/rubytapas-freebie-enumerator/">Ruby Tapas</a> episode by <a href="https://twitter.com/avdi">Avdi Grimm</a>.</p>

</div>


  <div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'absolventa-devnull'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



<div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
    <li>
      <span>25 Mar 2014 &raquo;</span> <a href="/2014/03/25/jsdoc-and-the-revealing-module-pattern/">JSDoc and the Revealing Module Pattern</a>
    </li>
    
    <li>
      <span>18 Mar 2014 &raquo;</span> <a href="/2014/03/18/converting-large-xml-documents-to-ruby-hashes/">Converting large XML documents to Ruby Hashes</a>
    </li>
    
    <li>
      <span>04 Feb 2014 &raquo;</span> <a href="/2014/02/04/a-lightweight-firewall-blacklist-as-rack-middleware/">A Lightweight Firewall/Blacklist as Rack-Middleware</a>
    </li>
    
  </ul>
</div>

    
      <div class="footer">
        <div class="disclaimer">
  

  <p>
    © ABSOLVENTA, 2013-2014 &mdash; built with Jekyll using Lagom theme
  </p>
</div>

      </div>
    </div>
  </div>


<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
   var t   = document.createElement('script');
   t.type  = 'text/javascript';
   t.async = true;
   t.id    = 'gauges-tracker';
   t.setAttribute('data-site-id', '52567bcc613f5d6ad7000042');
   t.src = '//secure.gaug.es/track.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(t, s);
   })();
</script>



</body>
</html>
